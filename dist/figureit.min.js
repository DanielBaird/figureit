/*! figureit 0.0.0 2013-12-08 */
!function(a,b){"function"==typeof define&&define.amd?define(b):a.workit=b()}(this,function(){var oldWorkit=window.workit;Array.prototype.forEach||(Array.prototype.forEach=function(a,b){"use strict";var c,d;for(c=0,d=this.length;d>c;++c)c in this&&a.call(b,this[c],c,this)});var elemId=function(a){return document.getElementById(a)},attach=function(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,c)},logFactory=function(a,b,c){var d=["debug","info","warn"];if(-1!=d.indexOf(b)&&(d.length=d.indexOf(b)),"none"===a||"console"===a&&!window.console)return function(){};if("console"===a)return function(a,b){if(b=b||"info",-1==d.indexOf(b))if("warn"===b)window.console.warn("[workit warn ]",a);else{var c=(b+"     ").substr(0,Math.max(b.length,5));window.console.log("[workit "+c+"]",a)}};if("dom"===a){var e=document.createElement("pre");return elemId(c).appendChild(e),function(a,b){if(b=b||"info",-1==d.indexOf(b)){var c=(b+"     ").substr(0,Math.max(b.length,5));e.innerHTML+="["+c+"] "+a+"\n"}}}},p2=function(a){return Math.pow(a,2)},p3=function(a){return Math.pow(a,3)},p4=function(a){return Math.pow(a,4)},sq=p2,cu=p3,pow=function(a,b){return Math.pow(a,b)},round=function(a,b){var c=Math.pow(10,b);return round(a*c)/c};return defaultOpts={debug:document.URL.indexOf("debug")>=0,logTo:"console",logLevel:"info",form:"workitform",output:"workitresult",showCalcDetail:"true"},{init:function(a,b){this.options={};var c;for(c in defaultOpts)this.options[c]=defaultOpts[c];for(c in b)this.options[c]=b[c];this.log="none"===this.options.logTo||"console"===this.options.logTo?logFactory(this.options.logTo,this.options.logLevel):logFactory("dom",this.options.logLevel,this.options.logTo),this.form=this.options.form,"string"==typeof this.form&&(this.form=document.getElementById(this.form)),this.output=this.options.output,"string"==typeof this.output&&(this.output=document.getElementById(this.output)),this.data=a,a.table&&(this.table=this.parseTable(a.table)),this.askVars=[],this.tableVars=[],this.calcVars=[],a.vars.forEach(function(a){"ask"===a.source?this.askVars.push(a.abbr):"calc"===a.source?this.calcVars.push(a.abbr):"table"===a.source&&this.tableVars.push(a.abbr)},this),this.buildForm()},buildForm:function(){data.vars.forEach(function(a){if("ask"===a.source){this.log('creating field to collect "'+a.abbr+'" variable',"debug");var b=this,c=document.createElement("div");c.setAttribute("class","form-element"),c.innerHTML+='<label for="var-'+a.abbr+'">'+a.name+"</label>",c.innerHTML+='<input type="number" id="var-'+a.abbr+'" name="var-'+a.abbr+'" value="'+a.defaultVal+'"/>',c.innerHTML+=a.units,c.innerHTML+='<span class="var-note" id="var-note-'+a.abbr+'"></span>',this.form.appendChild(c),attach(elemId("var-"+a.abbr),"change",function(){b.calculate()}),attach(elemId("var-"+a.abbr),"keyup",function(){b.calculate()})}},this),this.calculate()},calculate:function(){this.log("Calculating results..","debug"),this.results={},this.output.innerHTML="",this.getAskVars()&&(this.tableVars.length>0&&this.getTableVars(),this.calcVars.length>0&&this.getCalcVars(),this.log("Results below:","debug"),this.log(this.results,"debug"),this.showResults(),this.showConclusions())},getAskVars:function(){this.log("==== retrieving ask variables","debug");var a=!0;return data.vars.forEach(function(b){if("ask"===b.source){var c=elemId("var-"+b.abbr);if(elemId("var-note-"+b.abbr).innerHTML="",c){var d=c.value;d?(d=parseFloat(d),isNaN(d)||(b.failMin&&d<b.failMin||b.failMax&&d>b.failMax?(elemId("var-note-"+b.abbr).innerHTML=b.failMsg,a=!1):((d<b.warnMin||d>b.warnMax)&&(elemId("var-note-"+b.abbr).innerHTML=b.warnMsg),this.results[b.abbr]=d))):a=!1}else a=!1}},this),a},getTableVars:function(){this.log("==== calculating tabular results","debug");for(var a=[],b=0;b<this.table.length;b++)a.push(b);this.data.vars.forEach(function(b){if("ask"===b.source){this.log('testing table rows against var "'+b.abbr+'"',"debug");var c=this.results[b.abbr],d=function(a,b){return Math.abs(a-b)},e=d(this.table[a[0]][b.abbr],c);a.forEach(function(a){var f=d(c,this.table[a][b.abbr]);e>f&&(e=f)},this);var f=[];a.forEach(function(a){d(c,this.table[a][b.abbr])==e&&f.push(a)},this),a=f}},this),a.length>1&&this.log("there are multiple best table rows: "+a.join(", ")+" workit will use the first","info");var c=a[0];this.data.vars.forEach(function(a){"table"===a.source&&(this.results[a.abbr]=this.table[c][a.abbr])},this)},getCalcVars:function(){this.log("==== calculating formula-based results","debug"),this.data.vars.forEach(function(theVar){if("calc"===theVar.source)if(theVar.terms.length!=theVar.coefficients.length)this.log('"'+theVar.abbr+'" has mismatched terms and coefficients!',"warn");else{var term=theVar.terms.length,sum=0;this.results[theVar.abbr+"_termsInfo"]=[];for(var insertVar=function(a){expression=expression.replace(a.abbr,"("+this.results[a.abbr]+")")};term--;){var termInfo={},expression=theVar.terms[term];termInfo.exprInitial=expression,data.vars.forEach(insertVar(inputVar),this),termInfo.exprReplaced=expression,termInfo.exprResult=eval(expression),termInfo.coefficient=theVar.coefficients[term];var thisTerm=theVar.coefficients[term]*eval(expression);termInfo.result=thisTerm,sum+=thisTerm,this.results[theVar.abbr+"_termsInfo"].unshift(termInfo)}void 0===theVar.rounding?this.results[theVar.abbr]=sum:(this.results[theVar.abbr]=parseFloat(sum.toFixed(theVar.rounding)),this.results[theVar.abbr+"_precise"]=sum);var sumStr=sum.toFixed(theVar.rounding);theVar.lowcap&&sum<theVar.lowcap?sumStr=this.results[theVar.abbr+"_capped"]="< "+theVar.lowcap:theVar.highcap&&sum>theVar.highcap&&(sumStr="> "+theVar.highcap,this.results[theVar.abbr+"_capped"]="> "+theVar.highcap)}},this)},showResults:function(){this.log("==== displaying results","debug"),this.data.vars.forEach(function(a){if("ask"!==a.source&&!a.hidden){result=this.results[a.abbr+"_capped"]||this.results[a.abbr],resultPrecise=this.results[a.abbr+"_precise"],resultTermsInfo=this.results[a.abbr+"_termsInfo"];var b='<div id="calc-'+a.abbr+'" class="calcwrapper"><div class="result"><span class="name">'+a.name+"</span> ";if(b+=resultPrecise?'<span class="value" title="raw value: '+resultPrecise+" "+a.units+'">'+(result||"-")+"</span>":'<span class="value">'+(result||"-")+"</span>",b+='<span class="units">'+a.units+"</span></div>",this.options.showCalcDetail&&resultTermsInfo){var c=[];for(var d in resultTermsInfo[0])c.push(d);c.sort();var e="";e+='<button class="show info" onclick="document.getElementById(\'calc-'+a.abbr+"').className = 'calcwrapper wide';\">&gt;</button>",e+='<button class="hide info" onclick="document.getElementById(\'calc-'+a.abbr+"').className = 'calcwrapper';\">&lt;</button>",e+='<div class="calcinfo"><table>',e+='<tr><td colspan="'+c.length+'">Actual: '+resultPrecise+"</td></tr>",c.forEach(function(a){e+="<th>"+a+"</th>"}),resultTermsInfo.forEach(function(a){e+="<tr>",c.forEach(function(b){"number"==typeof a[b]?(e+='<td style="text-align: right" title="'+a[b]+'">',e+=a[b].toFixed(2)):(e+="<td>",e+=a[b]),e+="</td>"})}),e+="</table></div>",b+=e}b+="</div>",this.output.innerHTML+=b}},this)},showConclusions:function(){this.log("==== displaying conclusions","debug"),data.conclusions.forEach(function(conc){var condition=conc.condition,content=conc.content;this.log("evaluating conclusion with condition: "+condition,"debug"),this.data.vars.forEach(function(a){var b=this.results[a.abbr];condition=condition.split(a.abbr).join("("+(b||"false")+")"),content=content.split("$$"+a.abbr).join(b)},this),this.log(" ..condition is: "+condition,"debug"),eval(condition)?(this.log(" ..conclusion is true","debug"),this.output.innerHTML+='<div class="conclusion">'+content+"</div>"):(this.log(" ..conclusion is false","debug"),this.options.debug&&(this.output.innerHTML+='<div class="conclusion" style="opacity: 0.33"><span style="background: #ccc; padding: 0.2em 0.5em; position: relative; top: -0.1em; font-size: 66%; font-weight: bold">not showing:'+conc.condition+"</span> "+content+"</div>"))},this)},parseTable:function(a){var b=[];return a.forEach(function(a){var c={},d=a.split(/\s*,\s*/);d.forEach(function(a,b){c[data.columnOrder[b]]="-"===a?void 0:parseInt(a)}),b.push(c)}),b},noConflict:function(){window.workit=oldWorkit}}});